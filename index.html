<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>Assistant IA Vocal</title>
    <style>
        /* Style pour le corps de la page */
        body {
            /* On ajoute un espace en bas pour que le contenu ne soit pas cachÃ© par la barre de navigation */
            padding-bottom: 90px;
        }

        /* Conteneur principal de la barre de navigation */
        .bottom-navigation-bar {
            position: fixed;
            /* La barre reste visible mÃªme en scrollant */
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #121212;
            display: flex;
            /* Utilisation de Flexbox pour aligner les boutons */
            justify-content: space-around;
            /* Distribue l'espace Ã©quitablement autour des boutons */
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid #333;
            /* Petite bordure pour la finition */
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1003;
            /* <--- AJOUTEZ CETTE LIGNE */
        }

        /* Style commun pour chaque bouton et lien dans la barre */
        .nav-item {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
            /* EnlÃ¨ve le surlignage bleu sur mobile */
        }

        /* Style pour les icÃ´nes SVG */
        .nav-item svg {
            width: 32px;
            height: 32px;
            color: #a0a0a0;
            /* Couleur par dÃ©faut des icÃ´nes (flÃ¨che et hamburger) */
            transition: all 0.2s ease-in-out;
        }

        /* Effet au survol ou au clic pour amÃ©liorer l'expÃ©rience utilisateur */
        .nav-item:hover svg {
            color: #ffffff;
            transform: scale(1.1);
        }

        /* Styles spÃ©cifiques pour le bouton du milieu (Accueil) */
        #home-icon .outer-shape {
            stroke: #4a90e2;
            /* Le contour bleu/violet */
            stroke-width: 1.7;
            fill: none;
        }

        #home-icon .inner-shape {
            stroke: #d0d0d0;
            /* Le carrÃ© intÃ©rieur gris clair */
            stroke-width: 1.7;
            fill: none;
        }

        #home-button:hover #home-icon .outer-shape {
            stroke: #6cb0ff;
        }

        #home-button:hover #home-icon .inner-shape {
            stroke: #ffffff;
        }


        /* STYLES DE L'ASSISTANT (INCHANGÃ‰S) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            background-color: #1a1a1d;
            background-image: url('https://images.unsplash.com/photo-1550745165-9bc0b252726a?q=80&w=1920&auto-format&fit=crop');
            background-size: cover;
            background-position: center;
            padding-bottom: 90px;
            /* <--- LIGNE AJOUTÃ‰E ICI */
        }

        #assistant-card {
            width: 90%;
            max-width: 400px;
            padding: 40px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(25, 25, 29, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: box-shadow 0.2s ease-in-out;
        }

        #assistant-card.active-feedback {
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 0 0 2px rgba(255, 255, 255, 0.8);
        }

        #mic-container {
            transition: transform 0.2s ease;
        }

        #assistant-card:hover #mic-container {
            transform: scale(1.1);
        }

        #mic-icon {
            width: 50px;
            height: 50px;
        }

        #status {
            font-size: 1.2em;
            margin: 0;
            min-height: 1.5em;
            max-height: 200px;
            overflow-y: auto;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: none;
        }

        #listening-animation {
            display: none;
            height: 50px;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sound-wave {
            display: block;
            width: 5px;
            height: 8px;
            border-radius: 3px;
            background-color: white;
            animation: sound-wave-animation 1.2s infinite ease-in-out;
        }

        @keyframes sound-wave-animation {

            0%,
            40%,
            100% {
                transform: scaleY(0.5);
            }

            20% {
                transform: scaleY(2.5);
            }
        }

        .sound-wave:nth-child(2) {
            animation-delay: -1.0s;
        }

        .sound-wave:nth-child(3) {
            animation-delay: -0.8s;
        }

        .sound-wave:nth-child(4) {
            animation-delay: -0.6s;
        }

        #wiki-button {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            color: #222;
            padding: 12px 24px;
            border-radius: 30px;
            text-decoration: none;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease-in-out;
            z-index: 100;
            cursor: pointer;
        }

        #wiki-button:hover {
            background-color: #eee;
            transform: translateX(-50%) scale(1.05);
        }

        #stop-instruction {
            display: block;
            position: fixed;
            bottom: 80px;
            left: 0;
            width: 100%;
            margin: 0;
            padding: 10px 0;
            background-color: rgba(0, 0, 0, 0.3);
            font-size: 1em;
            font-weight: normal;
            z-index: 99;
        }

        #interrupt-button {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            border: none;
            border-radius: 0;
            transform: none;
            background-color: #DB4437;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            letter-spacing: 2px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: background-color 0.2s ease-in-out;
        }

        #interrupt-button:hover {
            background-color: #C33D2E;
        }

        #fullscreenBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 9999;
            width: 40px;
            height: 40px;
        }

        /* NOUVEAU : STYLES POUR LA VUE WIKIPÃ‰DIA */
        .hidden {
            display: none !important;
        }

        /* 1. ON MODIFIE LA VUE PRINCIPALE */
        #wiki-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #fff;
            color: #202122;
            z-index: 1001;
            overflow-y: auto;
            /* padding: 20px;  <-- ON RETIRE CETTE LIGNE */
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }

        /* 2. ON MODIFIE LE CONTENEUR DU TEXTE */
        #wiki-container {
            width: 100%;
            max-width: 1200px;
            padding: 0 25px;
            /* <--- ON AJOUTE LE PADDING GAUCHE/DROITE ICI */
            box-sizing: border-box;
            /* <--- ON AJOUTE Ã‡A POUR Ã‰VITER LES DÃ‰BORDEMENTS */
        }

        #close-wiki-btn {
            position: sticky;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            background-color: #222;
            color: #fff;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1002;
        }

        #wiki-content {
            font-family: "Georgia", "Times New Roman", serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            word-wrap: break-word;
            line-height: 1.8;
            font-size: 1.2em;
            margin-top: 20px;
        }

        /* ===== LEFT PHOTO PANEL ===== */
        #left-photo-panel {
            position: fixed;
            left: 0;
            top: 0;
            width: 30%;
            height: 100%;
            background: #0a0a0a;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            cursor: pointer;
            overflow: hidden;
            border-right: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        }

        #left-photo-panel #left-panel-img {
            max-width: 96%;
            max-height: 96vh;
            object-fit: contain;
            image-orientation: from-image;
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #left-photo-panel #left-panel-img:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.15);
        }

        #left-photo-panel .panel-placeholder {
            color: #555;
            font-size: 1.1em;
            text-align: center;
            padding: 20px;
        }

        /* Push main content right ONLY when panel is visible */
        body.with-panel {
            padding-left: 30%;
        }

        body.with-panel #stop-instruction {
            left: 30%;
            width: 70%;
        }

        body.with-panel #interrupt-button {
            left: 30%;
            width: 70%;
        }

        body.with-panel .bottom-navigation-bar {
            left: 30%;
            width: 70%;
        }

        /* Navbar needs to be ON TOP of the modal (z-index 10000) */
        .bottom-navigation-bar {
            z-index: 20000 !important;
            /* Higher than modal */
        }

        /* ===== PHOTO MODAL ===== */
        #photo-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.97);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #photo-modal-overlay.visible {
            display: flex;
        }

        #photo-modal-overlay #modal-img {
            max-width: 85%;
            max-height: 85vh;
            object-fit: contain;
            image-orientation: from-image;
            border-radius: 8px;
        }

        #modal-close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 2em;
            width: 55px;
            height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10001;
            border-radius: 50%;
            transition: all 0.2s;
        }

        #modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modal-nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #FF0000, #CC0000);
            color: #fff;
            border: 3px solid #fff;
            font-size: 2.5em;
            font-weight: bold;
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 50%;
            z-index: 10001;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(255, 0, 0, 0.5);
            user-select: none;
        }

        .modal-nav-arrow:hover {
            transform: translateY(-50%) scale(1.15);
            box-shadow: 0 6px 30px rgba(255, 0, 0, 0.8);
        }

        .modal-nav-arrow:active {
            transform: translateY(-50%) scale(0.95);
        }

        #modal-arrow-left {
            left: 20px;
        }

        #modal-arrow-right {
            right: 20px;
        }

        #modal-position {
            position: absolute;
            bottom: 25px;
            color: white;
            font-size: 1.3em;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 25px;
            border-radius: 20px;
        }

        /* ===== RING NOTIFICATION ===== */
        #ring-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10002;
            justify-content: center;
            align-items: center;
        }

        #ring-overlay.visible {
            display: flex;
        }

        .ring-box {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid #FFD700;
            border-radius: 25px;
            padding: 50px 70px;
            text-align: center;
            animation: ringPulse 0.6s infinite alternate;
        }

        .ring-box .ring-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .ring-box .ring-text {
            font-size: 1.8em;
            color: #FFD700;
            font-weight: bold;
        }

        .ring-box .ring-countdown {
            margin-top: 20px;
            font-size: 3em;
            color: #fff;
            font-weight: bold;
        }

        @keyframes ringPulse {
            from {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            }

            to {
                transform: scale(1.05);
                box-shadow: 0 0 60px rgba(255, 215, 0, 0.7);
            }
        }
    </style>
</head>

<body>

    <!-- LEFT PHOTO PANEL -->
    <div id="left-photo-panel">
        <p class="panel-placeholder">Chargement...</p>
    </div>

    <div id="main-interface">
        <a id="wiki-button" style="display: none;">
            Consulter sur WikipÃ©dia
        </a>
        <div id="assistant-card">
            <div id="mic-container">
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                    <path fill="white"
                        d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h144c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z" />
                </svg>
            </div>
            <div id="listening-animation">
                <span class="sound-wave"></span><span class="sound-wave"></span><span class="sound-wave"></span><span
                    class="sound-wave"></span>
            </div>
            <p id="status">Comment puis-je vous aider ?</p>
        </div>
        <p id="stop-instruction">Pour arrÃªter la conversation dites-moi "j'arrÃªte"</p>
        <button id="interrupt-button">STOP</button>
    </div>

    <div id="wiki-view" class="hidden">
        <div id="wiki-container">
            <button id="close-wiki-btn">Retour</button>
            <div id="wiki-content"></div>
        </div>
    </div>

    <button id="fullscreenBtn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"
            width="100%" height="100%">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M8 3H5a2 2 0 00-2 2v3m0 8v3a2 2 0 002 2h3m8-16h3a2 2 0 012 2v3m0 8v3a2 2 0 01-2 2h-3" />
        </svg>
    </button>

    <script>
        // SÃ‰LECTION DES Ã‰LÃ‰MENTS
        const assistantCard = document.getElementById('assistant-card');
        const micContainer = document.getElementById('mic-container');
        const statusDiv = document.getElementById('status');
        const listeningAnimation = document.getElementById('listening-animation');
        const wikiButton = document.getElementById('wiki-button');
        const interruptButton = document.getElementById('interrupt-button');

        // NOUVEAU : Ã‰lÃ©ments pour la vue WikipÃ©dia
        const mainInterface = document.getElementById('main-interface');
        const wikiView = document.getElementById('wiki-view');
        const wikiContent = document.getElementById('wiki-content');
        const closeWikiBtn = document.getElementById('close-wiki-btn');

        const API_KEY = "AIzaSyAUqkLGpC-N4bhPS42HSAMTCM54ciO9XEI"; // Gardez votre clÃ©

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synthesis = window.speechSynthesis;

        let isConfirmingStop = false;
        let autoRestart = false;

        if (!SpeechRecognition || !synthesis) {
            statusDiv.textContent = "API vocales non supportÃ©es.";
            micContainer.style.display = 'none';
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = false;

            function speak(text, onEndCallback) {
                autoRestart = false;
                if (synthesis.speaking) synthesis.cancel();
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'fr-FR';
                    utterance.onend = () => { if (onEndCallback) onEndCallback(); };
                    synthesis.speak(utterance);
                }, 100);
            }

            async function searchWikipedia(subject) {
                if (!subject) return;
                const endpoint = `https://fr.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(subject)}&limit=1&namespace=0&format=json&origin=*`;
                try {
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    const pageTitle = data[1]?.[0];
                    if (pageTitle) {
                        wikiButton.dataset.subject = pageTitle;
                        wikiButton.style.display = 'inline-block';
                    }
                } catch (error) { console.error("Erreur API WikipÃ©dia:", error); }
            }

            async function callGeminiAPI(prompt) {
                autoRestart = false;
                statusDiv.textContent = "L'IA rÃ©flÃ©chit...";
                wikiButton.style.display = 'none';

                // LIGNE RESTAURÃ‰E COMME DANS VOTRE CODE D'ORIGINE
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

                const fullPrompt = `RÃ©ponds Ã  la question suivante. En plus de ta rÃ©ponse, identifie l'entitÃ© (personne, lieu, concept) la plus pertinente de ta rÃ©ponse pour une recherche WikipÃ©dia. Formate ta sortie EXCLUSIVEMENT en JSON avec deux clÃ©s : "reponse" pour ton texte, et "sujet" pour l'entitÃ©. Si aucun sujet n'est pertinent, mets "sujet" Ã  null. La question est : "${prompt}"`;

                try {
                    const res = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                    });
                    if (!res.ok) {
                        const errorData = await res.json();
                        throw new Error(errorData.error.message || `Erreur ${res.status}`);
                    }
                    const data = await res.json();
                    let apiContent = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    let parsedResponse;
                    const jsonMatch = apiContent.match(/{[\s\S]*}/);

                    if (jsonMatch) {
                        try { parsedResponse = JSON.parse(jsonMatch[0]); }
                        catch (e) { parsedResponse = { reponse: apiContent, sujet: null }; }
                    } else { parsedResponse = { reponse: apiContent, sujet: null }; }

                    const { reponse, sujet } = parsedResponse;

                    if (reponse) {
                        statusDiv.textContent = reponse;
                        searchWikipedia(sujet);
                        const cleanTextForSpeech = reponse.replaceAll('*', '');
                        speak(cleanTextForSpeech, () => {
                            startListeningUI();
                            autoRestart = true;
                            recognition.start();
                        });
                    } else { throw new Error("Aucune rÃ©ponse textuelle reÃ§ue de l'API."); }
                } catch (err) {
                    console.error("Erreur Gemini:", err);
                    statusDiv.textContent = `Erreur: ${err.message}`;
                    speak(`Une erreur est survenue.`);
                }
            }

            function startListeningUI() { micContainer.style.display = 'none'; listeningAnimation.style.display = 'flex'; statusDiv.textContent = "Je vous Ã©coute..."; }
            function stopListeningUI() { micContainer.style.display = 'block'; listeningAnimation.style.display = 'none'; }

            const startVocalAssistant = (event) => {
                if (event) event.preventDefault();
                assistantCard.classList.add('active-feedback');
                setTimeout(() => assistantCard.classList.remove('active-feedback'), 200);
                if (listeningAnimation.style.display === 'flex') return;
                wikiButton.style.display = 'none';
                speak("Bonjour", () => {
                    startListeningUI();
                    autoRestart = true;
                    recognition.start();
                });
            };

            assistantCard.addEventListener('mousedown', startVocalAssistant);
            assistantCard.addEventListener('touchstart', startVocalAssistant);

            interruptButton.addEventListener('click', () => {
                autoRestart = false;
                synthesis.cancel();
                isConfirmingStop = true;
                speak("Voulez-vous continuer Ã  parler ?", () => {
                    startListeningUI();
                    recognition.start();
                });
            });

            recognition.onresult = (event) => {
                autoRestart = false;
                const transcript = event.results[0][0].transcript.toLowerCase().trim();
                if (isConfirmingStop) {
                    isConfirmingStop = false;
                    if (transcript.includes("oui")) {
                        speak("D'accord, posez votre question.", () => {
                            startListeningUI();
                            autoRestart = true;
                            recognition.start();
                        });
                    } else {
                        statusDiv.textContent = "Au revoir !";
                        speak("Au revoir");
                    }
                } else {
                    if (transcript.includes("j'arrÃªte") || transcript.includes("arrÃªte") || transcript.includes("arrÃªter")) {
                        statusDiv.textContent = "Au revoir !";
                        speak("Au revoir");
                    } else {
                        callGeminiAPI(transcript);
                    }
                }
            };

            recognition.onend = () => {
                if (autoRestart) recognition.start();
                else stopListeningUI();
            };

            recognition.onerror = (event) => {
                console.error("Erreur reconnaissance:", event.error);
                if (event.error === 'no-speech') {
                    statusDiv.textContent = "Je n'ai rien entendu, je relance l'Ã©coute...";
                    autoRestart = true;
                } else {
                    // C'est cette partie que nous modifions
                    statusDiv.textContent = "Une erreur est survenue, rechargement..."; // 1. Affiche un message
                    setTimeout(() => {
                        location.reload(); // 2. Recharge la page aprÃ¨s 2 secondes
                    }, 2000);
                }
            };
        }

        async function loadWiki(article) {
            wikiContent.innerHTML = "<h2>Chargement de l'article...</h2>";
            const url = `https://fr.wikipedia.org/w/api.php?action=parse&page=${article}&format=json&origin=*&prop=text&disabletoc=true`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.parse && data.parse.text) {
                    wikiContent.innerHTML = data.parse.text["*"];
                    wikiContent.querySelectorAll('.infobox, .mw-editsection, .reference').forEach(el => el.remove());
                    wikiContent.querySelectorAll('a').forEach(a => {
                        a.style.pointerEvents = 'none';
                        a.style.color = 'inherit';
                        a.style.textDecoration = 'none';
                    });
                    wikiContent.querySelectorAll('img').forEach(img => {
                        img.style.display = 'block';
                        img.style.margin = '20px auto';
                        img.style.width = '90%';
                        img.style.maxWidth = '600px';
                        img.style.height = 'auto';
                    });
                    wikiContent.querySelectorAll('figcaption, .thumbcaption').forEach(caption => {
                        caption.style.width = '90%';
                        caption.style.textAlign = 'center';
                        caption.style.margin = '0 auto 20px auto';
                        caption.style.fontSize = '0.9em';
                        caption.style.color = '#555';
                    });
                } else {
                    wikiContent.innerHTML = "<p>Article non trouvÃ©.</p>";
                }
            } catch (error) {
                console.error("Erreur chargement Wiki:", error);
                wikiContent.innerHTML = "<p>Impossible de charger l'article.</p>";
            }
        }

        wikiButton.addEventListener('click', async (event) => {
            const subject = event.currentTarget.dataset.subject;
            if (!subject) return;
            mainInterface.classList.add('hidden');
            wikiView.classList.remove('hidden');
            await loadWiki(subject);
        });

        closeWikiBtn.addEventListener('click', () => {
            wikiView.classList.add('hidden');
            mainInterface.classList.remove('hidden');
            wikiContent.innerHTML = '';
        });

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Erreur: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });
    </script>
    <script>
        // Au chargement, descend de 200px
        window.addEventListener("load", () => {
            window.scrollTo({ top: 200, behavior: "smooth" });
        });

        // Quand on remonte, force Ã  redescendre Ã  200px
        let lastY = 0;
        window.addEventListener("scroll", () => {
            if (window.scrollY < lastY && window.scrollY < 200) {
                window.scrollTo({ top: 200, behavior: "smooth" });
            }
            lastY = window.scrollY;
        });
    </script>
    <!-- PHOTO MODAL -->
    <div id="photo-modal-overlay">
        <button id="modal-close-btn">âœ•</button>
        <button class="modal-nav-arrow" id="modal-arrow-left">â€¹</button>
        <img id="modal-img" src="" alt="Photo agrandie">
        <button class="modal-nav-arrow" id="modal-arrow-right">â€º</button>
        <div id="modal-position"></div>
    </div>

    <!-- RING NOTIFICATION -->
    <div id="ring-overlay">
        <div class="ring-box">
            <div class="ring-icon">ðŸ””</div>
            <div class="ring-text">Nouvelle photo !</div>
            <div class="ring-countdown" id="ring-countdown">10</div>
        </div>
    </div>

    <nav class="bottom-navigation-bar">

        <button class="nav-item" aria-label="PrÃ©cÃ©dent">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>

        <a href="index.html" class="nav-item" id="home-button" aria-label="Accueil">
            <svg id="home-icon" viewBox="0 0 28 28">
                <path class="outer-shape" d="M14 2 L23 5 L26 14 L23 23 L14 26 L5 23 L2 14 L5 5 Z" />
                <rect class="inner-shape" x="8.5" y="8.5" width="11" height="11" rx="1" />
            </svg>
        </a>

        <button class="nav-item" aria-label="Menu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

    </nav>
    <script>
        (function () {
            // === CONFIGURATION ===
            const CLOUD_NAME = "dl7zjztb1";
            const TAG_TO_FETCH = "mon-site-gallerie";
            const RING_TAG = "sonnerie_signal";
            const EXPIRATION_TIME = 24 * 60 * 60 * 1000;

            // === LEFT PANEL: Load and display latest image ===
            const leftPanel = document.getElementById('left-photo-panel');
            let panelImages = [];  // Latest batch for left panel display
            let allGalleryImages = [];  // ALL images for modal gallery navigation
            let panelIndex = 0;

            async function loadLeftPanelImages() {
                const listUrl = `https://res.cloudinary.com/${CLOUD_NAME}/image/list/${TAG_TO_FETCH}.json?_t=${Date.now()}`;
                try {
                    const response = await fetch(listUrl);
                    if (!response.ok) {
                        if (response.status === 403 || response.status === 404) {
                            leftPanel.innerHTML = '<div style="padding:20px;text-align:center;color:#ff4444;font-size:1.2em;font-weight:bold;">ERREUR DE RÃ‰CEPTION<br><br>Allez sur Cloudinary > Settings > Security<br>DÃ©cochez "Resource list"</div>';
                            return;
                        }
                        throw new Error('Failed to fetch');
                    }
                    const data = await response.json();

                    if (data.resources && data.resources.length > 0) {
                        const sorted = data.resources.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        const now = Date.now();
                        // Filter: Must be < 24h AND newer than the last time user clicked "Home" to close modal
                        const lastViewedTime = parseInt(localStorage.getItem('lastViewedTime') || '0');

                        const valid = sorted.filter(img => {
                            const imgTime = new Date(img.created_at).getTime();
                            return (now - imgTime) < EXPIRATION_TIME && imgTime > lastViewedTime;
                        });

                        // Also store ALL valid images (ignoring "viewed" status) for gallery navigation if needed?
                        // The user said: "I want it to disappear". So we strictly respect the filter.
                        // However, if we hide the panel, we can't open the modal.
                        // So filtering 'valid' controls visibility.

                        // Store ALL recent (<24h) images for gallery navigation, even if viewed?
                        // No, if panel is hidden, we can't access them anyway.

                        // For the modal navigation to work on ALL images (history), we need a separate list.
                        // But left panel visibility is strictly for "NEW" items.

                        allGalleryImages = sorted.map(img => ({
                            url: `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${img.public_id}.${img.format}`,
                            created_at: img.created_at
                        }));

                        if (valid.length === 0) {
                            // No recent images -> Hide panel, reset layout
                            leftPanel.style.display = 'none';
                            document.body.classList.remove('with-panel');
                            return;
                        }

                        // Recent images found -> Show panel, shift layout
                        leftPanel.style.display = 'flex';
                        document.body.classList.add('with-panel');

                        const withBatch = valid.map(img => {
                            const batchTag = img.tags?.find(tag => tag.startsWith('batch_'));
                            return { ...img, batchId: batchTag || null };
                        });

                        const latestBatchId = withBatch[0].batchId;

                        if (latestBatchId) {
                            panelImages = withBatch
                                .filter(img => img.batchId === latestBatchId)
                                .map(img => ({
                                    url: `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${img.public_id}.${img.format}`,
                                    created_at: img.created_at
                                }));
                        } else {
                            panelImages = [{
                                url: `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${valid[0].public_id}.${valid[0].format}`,
                                created_at: valid[0].created_at
                            }];
                        }

                        panelIndex = 0;
                        displayLeftPanelImage();
                    } else {
                        // No images at all -> Hide panel
                        leftPanel.style.display = 'none';
                        document.body.classList.remove('with-panel');
                    }
                } catch (error) {
                    console.error('Erreur chargement panel:', error);
                    // On error, hide panel to be safe
                    leftPanel.style.display = 'none';
                    document.body.classList.remove('with-panel');
                }
            }

            function displayLeftPanelImage() {
                if (panelImages.length === 0) return;
                leftPanel.innerHTML = '';
                const img = document.createElement('img');
                img.id = 'left-panel-img';
                img.src = panelImages[panelIndex].url;
                img.alt = 'DerniÃ¨re photo envoyÃ©e';
                leftPanel.appendChild(img);
            }

            // Load on start and refresh every 30 seconds
            loadLeftPanelImages();
            setInterval(loadLeftPanelImages, 30000);

            // === MODAL: Fullscreen image viewer with navigation ===
            const modalOverlay = document.getElementById('photo-modal-overlay');
            const modalImg = document.getElementById('modal-img');
            const modalClose = document.getElementById('modal-close-btn');
            const modalArrowLeft = document.getElementById('modal-arrow-left');
            const modalArrowRight = document.getElementById('modal-arrow-right');
            const modalPosition = document.getElementById('modal-position');
            let modalIndex = 0;

            leftPanel.addEventListener('click', () => {
                if (allGalleryImages.length === 0) return;
                modalIndex = 0; // Start at the latest image
                openModal();
            });

            function openModal() {
                modalImg.src = allGalleryImages[modalIndex].url;
                updateModalNav();
                modalOverlay.classList.add('visible');
            }

            function closeModal() {
                modalOverlay.classList.remove('visible');
            }

            function updateModalNav() {
                // Always show arrows if there are images to navigate to
                modalArrowLeft.style.display = (modalIndex > 0) ? 'flex' : 'none';
                modalArrowRight.style.display = (modalIndex < allGalleryImages.length - 1) ? 'flex' : 'none';
                if (allGalleryImages.length > 1) {
                    modalPosition.textContent = `${modalIndex + 1} / ${allGalleryImages.length}`;
                    modalPosition.style.display = 'block';
                } else {
                    modalPosition.style.display = 'none';
                }
            }

            modalClose.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            modalArrowLeft.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalIndex > 0) {
                    modalIndex--;
                    modalImg.src = allGalleryImages[modalIndex].url;
                    updateModalNav();
                }
            });

            modalArrowRight.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modalIndex < allGalleryImages.length - 1) {
                    modalIndex++;
                    modalImg.src = allGalleryImages[modalIndex].url;
                    updateModalNav();
                }
            });

            // === Home Button Interaction ===
            const homeButton = document.getElementById('home-button');
            homeButton.addEventListener('click', (e) => {
                // If modal is open
                if (modalOverlay.classList.contains('visible')) {
                    e.preventDefault();

                    // Mark global "viewed" timestamp
                    // We set it to the timestamp of the LATEST image we have loaded, 
                    // or just NOW if we want to be aggressive.
                    // Let's use NOW to be sure we hide everything currently displayed.
                    localStorage.setItem('lastViewedTime', Date.now().toString());

                    closeModal();

                    // Refresh accessibility of panel (it should disappear)
                    loadLeftPanelImages();
                }
            });

            // === Long Press / Context Menu Prevention ===
            // Prevents the context menu from appearing on long press for elderly accessibility
            const preventLongPressMenu = (element) => {
                if (!element) return;
                element.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });
                // Ensure click fires even if held long
                element.style.userSelect = 'none';
                element.style.webkitUserSelect = 'none';
                element.style.webkitTouchCallout = 'none';
            };

            preventLongPressMenu(leftPanel);
            preventLongPressMenu(modalArrowLeft);
            preventLongPressMenu(modalArrowRight);

            document.addEventListener('keydown', (e) => {
                if (!modalOverlay.classList.contains('visible')) return;
                if (e.key === 'ArrowLeft' && modalIndex > 0) {
                    modalIndex--;
                    modalImg.src = allGalleryImages[modalIndex].url;
                    updateModalNav();
                }
                if (e.key === 'ArrowRight' && modalIndex < allGalleryImages.length - 1) {
                    modalIndex++;
                    modalImg.src = allGalleryImages[modalIndex].url;
                    updateModalNav();
                }
                if (e.key === 'Escape') closeModal();
            });

            // === RING NOTIFICATION ===
            const ringOverlay = document.getElementById('ring-overlay');
            const ringCountdownEl = document.getElementById('ring-countdown');
            let lastRingCheck = Date.now();
            let ringTimer = null;
            let ringAudioCtx = null;

            function playRingSound10s() {
                try {
                    ringAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    // Generate 10 seconds of alternating ring tones
                    const totalBeeps = 28; // ~10 seconds of sound
                    for (let i = 0; i < totalBeeps; i++) {
                        const osc = ringAudioCtx.createOscillator();
                        const gain = ringAudioCtx.createGain();
                        osc.connect(gain);
                        gain.connect(ringAudioCtx.destination);
                        osc.frequency.value = (i % 2 === 0) ? 800 : 1000;
                        osc.type = 'sine';
                        const startTime = ringAudioCtx.currentTime + i * 0.35;
                        gain.gain.setValueAtTime(0.5, startTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                        osc.start(startTime);
                        osc.stop(startTime + 0.3);
                    }
                } catch (e) {
                    console.error('Audio error:', e);
                }
            }

            function stopRingSound() {
                if (ringAudioCtx) {
                    try { ringAudioCtx.close(); } catch (e) { }
                    ringAudioCtx = null;
                }
            }

            function showRingNotification() {
                // Clear any existing timer
                if (ringTimer) clearInterval(ringTimer);

                playRingSound10s();
                ringOverlay.classList.add('visible');

                // Start 10-second countdown
                let secondsLeft = 10;
                ringCountdownEl.textContent = secondsLeft;

                ringTimer = setInterval(() => {
                    secondsLeft--;
                    ringCountdownEl.textContent = secondsLeft;
                    if (secondsLeft <= 0) {
                        clearInterval(ringTimer);
                        ringTimer = null;
                        ringOverlay.classList.remove('visible');
                        stopRingSound();
                    }
                }, 1000);
            }

            // Check for ring signal via Cloudinary
            async function checkForRing() {
                try {
                    const response = await fetch(`https://res.cloudinary.com/${CLOUD_NAME}/image/list/${RING_TAG}.json`, { cache: 'no-store' });
                    if (!response.ok) return;
                    const data = await response.json();
                    if (data.resources && data.resources.length > 0) {
                        const latest = data.resources.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                        const ringTime = new Date(latest.created_at).getTime();
                        if (ringTime > lastRingCheck) {
                            lastRingCheck = Date.now();
                            showRingNotification();
                            loadLeftPanelImages();
                        }
                    }
                } catch (e) {
                    console.error('Ring check error:', e);
                }
            }

            setInterval(checkForRing, 5000);

            // Also listen for localStorage events (same browser/device)
            window.addEventListener('storage', (e) => {
                if (e.key === 'ring_signal') {
                    showRingNotification();
                    loadLeftPanelImages();
                }
            });
        })();
    </script>
</body>

</html>
