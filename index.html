<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>Assistant IA Vocal</title>
    <style>
    /* Style pour le corps de la page */
    body {
        /* On ajoute un espace en bas pour que le contenu ne soit pas caché par la barre de navigation */
        padding-bottom: 90px; 
    }

    /* Conteneur principal de la barre de navigation */
    .bottom-navigation-bar {
        position: fixed; /* La barre reste visible même en scrollant */
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #121212;
        display: flex; /* Utilisation de Flexbox pour aligner les boutons */
        justify-content: space-around; /* Distribue l'espace équitablement autour des boutons */
        align-items: center;
        padding: 10px 0;
        border-top: 1px solid #333; /* Petite bordure pour la finition */
        box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000; /* <--- AJOUTEZ CETTE LIGNE */
    }

    /* Style commun pour chaque bouton et lien dans la barre */
    .nav-item {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        -webkit-tap-highlight-color: transparent; /* Enlève le surlignage bleu sur mobile */
    }

    /* Style pour les icônes SVG */
    .nav-item svg {
        width: 32px;
        height: 32px;
        color: #a0a0a0; /* Couleur par défaut des icônes (flèche et hamburger) */
        transition: all 0.2s ease-in-out;
    }

    /* Effet au survol ou au clic pour améliorer l'expérience utilisateur */
    .nav-item:hover svg {
        color: #ffffff;
        transform: scale(1.1);
    }

    /* Styles spécifiques pour le bouton du milieu (Accueil) */
    #home-icon .outer-shape {
        stroke: #4a90e2; /* Le contour bleu/violet */
        stroke-width: 1.7;
        fill: none;
    }
    #home-icon .inner-shape {
        stroke: #d0d0d0; /* Le carré intérieur gris clair */
        stroke-width: 1.7;
        fill: none;
    }
    #home-button:hover #home-icon .outer-shape {
        stroke: #6cb0ff;
    }
    #home-button:hover #home-icon .inner-shape {
        stroke: #ffffff;
    }


        /* STYLES DE L'ASSISTANT (INCHANGÉS) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            background-color: #1a1a1d;
            background-image: url('https://images.unsplash.com/photo-1550745165-9bc0b252726a?q=80&w=1920&auto-format&fit=crop');
            background-size: cover;
            background-position: center;
            padding-bottom: 90px; /* <--- LIGNE AJOUTÉE ICI */
        }
        
        #assistant-card {
            width: 90%;
            max-width: 400px;
            padding: 40px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(25, 25, 29, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: box-shadow 0.2s ease-in-out;
        }
        
        #assistant-card.active-feedback {
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 0 0 2px rgba(255, 255, 255, 0.8);
        }

        #mic-container { transition: transform 0.2s ease; }
        #assistant-card:hover #mic-container { transform: scale(1.1); }
        #mic-icon { width: 50px; height: 50px; }
        #status { font-size: 1.2em; margin: 0; min-height: 1.5em; max-height: 200px; overflow-y: auto; user-select: none; -webkit-user-select: none; pointer-events: none; }
        #listening-animation { display: none; height: 50px; align-items: center; justify-content: center; gap: 8px; }
        .sound-wave { display: block; width: 5px; height: 8px; border-radius: 3px; background-color: white; animation: sound-wave-animation 1.2s infinite ease-in-out; }
        @keyframes sound-wave-animation { 0%, 40%, 100% { transform: scaleY(0.5); } 20% { transform: scaleY(2.5); } }
        .sound-wave:nth-child(2) { animation-delay: -1.0s; }
        .sound-wave:nth-child(3) { animation-delay: -0.8s; }
        .sound-wave:nth-child(4) { animation-delay: -0.6s; }
        #wiki-button { position: fixed; top: 25px; left: 50%; transform: translateX(-50%); background-color: #fff; color: #222; padding: 12px 24px; border-radius: 30px; text-decoration: none; font-size: 1em; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.2s ease-in-out; z-index: 100; cursor:pointer; }
        #wiki-button:hover { background-color: #eee; transform: translateX(-50%) scale(1.05); }
        #stop-instruction { display: block; position: fixed; bottom: 80px; left: 0; width: 100%; margin: 0; padding: 10px 0; background-color: rgba(0, 0, 0, 0.3); font-size: 1em; font-weight: normal; z-index: 99; }
        #interrupt-button { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; border: none; border-radius: 0; transform: none; background-color: #DB4437; color: white; font-size: 1.5em; font-weight: bold; letter-spacing: 2px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 100; transition: background-color 0.2s ease-in-out; }
        #interrupt-button:hover { background-color: #C33D2E; }
        #fullscreenBtn { position: fixed; top: 10px; right: 10px; background: none; border: none; cursor: pointer; z-index: 9999; width: 40px; height: 40px; }

        /* NOUVEAU : STYLES POUR LA VUE WIKIPÉDIA */
        .hidden {
            display: none !important;
        }

        #wiki-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: #fff;
            color: #202122;
            z-index: 1001;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }

        #wiki-container {
            width: 100%;
            max-width: 1200px;
        }

        #close-wiki-btn {
            position: sticky;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            background-color: #222;
            color: #fff;
            border: none;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1002;
        }

        #wiki-content {
            font-family: "Georgia", "Times New Roman", serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            word-wrap: break-word;
            line-height: 1.8;
            font-size: 1.2em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    
    <div id="main-interface">
        <a id="wiki-button" style="display: none;">
            Consulter sur Wikipédia
        </a>
        <div id="assistant-card">
            <div id="mic-container">
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                    <path fill="white" d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h144c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/>
                </svg>
            </div>
            <div id="listening-animation">
                <span class="sound-wave"></span><span class="sound-wave"></span><span class="sound-wave"></span><span class="sound-wave"></span>
            </div>
            <p id="status">Comment puis-je vous aider ?</p>
        </div>
        <p id="stop-instruction">Pour arrêter la conversation dites-moi "j'arrête"</p>
        <button id="interrupt-button">STOP</button>
    </div>

    <div id="wiki-view" class="hidden">
        <div id="wiki-container">
            <button id="close-wiki-btn">Retour</button>
            <div id="wiki-content"></div>
        </div>
    </div>
    
    <button id="fullscreenBtn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2" width="100%" height="100%">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 3H5a2 2 0 00-2 2v3m0 8v3a2 2 0 002 2h3m8-16h3a2 2 0 012 2v3m0 8v3a2 2 0 01-2 2h-3"/>
      </svg>
    </button>
    
    <script>
        // SÉLECTION DES ÉLÉMENTS
        const assistantCard = document.getElementById('assistant-card');
        const micContainer = document.getElementById('mic-container');
        const statusDiv = document.getElementById('status');
        const listeningAnimation = document.getElementById('listening-animation');
        const wikiButton = document.getElementById('wiki-button');
        const interruptButton = document.getElementById('interrupt-button');
        
        // NOUVEAU : Éléments pour la vue Wikipédia
        const mainInterface = document.getElementById('main-interface');
        const wikiView = document.getElementById('wiki-view');
        const wikiContent = document.getElementById('wiki-content');
        const closeWikiBtn = document.getElementById('close-wiki-btn');

        const API_KEY = "AIzaSyAUqkLGpC-N4bhPS42HSAMTCM54ciO9XEI"; // Gardez votre clé
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synthesis = window.speechSynthesis;

        let isConfirmingStop = false;
        let autoRestart = false; 

        if (!SpeechRecognition || !synthesis) {
            statusDiv.textContent = "API vocales non supportées.";
            micContainer.style.display = 'none';
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = false;

            function speak(text, onEndCallback) {
                autoRestart = false; 
                if (synthesis.speaking) synthesis.cancel();
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'fr-FR';
                    utterance.onend = () => { if (onEndCallback) onEndCallback(); };
                    synthesis.speak(utterance);
                }, 100);
            }
            
            async function searchWikipedia(subject) {
                if (!subject) return;
                const endpoint = `https://fr.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(subject)}&limit=1&namespace=0&format=json&origin=*`;
                try {
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    const pageTitle = data[1]?.[0]; 
                    if (pageTitle) {
                        wikiButton.dataset.subject = pageTitle; 
                        wikiButton.style.display = 'inline-block';
                    }
                } catch (error) { console.error("Erreur API Wikipédia:", error); }
            }

            async function callGeminiAPI(prompt) {
                autoRestart = false; 
                statusDiv.textContent = "L'IA réfléchit...";
                wikiButton.style.display = 'none';
                
                // LIGNE RESTAURÉE COMME DANS VOTRE CODE D'ORIGINE
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
                
                const fullPrompt = `Réponds à la question suivante. En plus de ta réponse, identifie l'entité (personne, lieu, concept) la plus pertinente de ta réponse pour une recherche Wikipédia. Formate ta sortie EXCLUSIVEMENT en JSON avec deux clés : "reponse" pour ton texte, et "sujet" pour l'entité. Si aucun sujet n'est pertinent, mets "sujet" à null. La question est : "${prompt}"`;

                try {
                    const res = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }]}] })
                    });
                    if (!res.ok) {
                        const errorData = await res.json();
                        throw new Error(errorData.error.message || `Erreur ${res.status}`);
                    }
                    const data = await res.json();
                    let apiContent = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    let parsedResponse;
                    const jsonMatch = apiContent.match(/{[\s\S]*}/);

                    if (jsonMatch) {
                        try { parsedResponse = JSON.parse(jsonMatch[0]); } 
                        catch (e) { parsedResponse = { reponse: apiContent, sujet: null }; }
                    } else { parsedResponse = { reponse: apiContent, sujet: null }; }

                    const { reponse, sujet } = parsedResponse;

                    if (reponse) {
                        statusDiv.textContent = reponse;
                        searchWikipedia(sujet);
                        const cleanTextForSpeech = reponse.replaceAll('*', '');
                        speak(cleanTextForSpeech, () => {
                            startListeningUI();
                            autoRestart = true; 
                            recognition.start();
                        });
                    } else { throw new Error("Aucune réponse textuelle reçue de l'API."); }
                } catch (err) {
                    console.error("Erreur Gemini:", err);
                    statusDiv.textContent = `Erreur: ${err.message}`;
                    speak(`Une erreur est survenue.`);
                }
            }

            function startListeningUI() { micContainer.style.display = 'none'; listeningAnimation.style.display = 'flex'; statusDiv.textContent = "Je vous écoute..."; }
            function stopListeningUI() { micContainer.style.display = 'block'; listeningAnimation.style.display = 'none'; }

            const startVocalAssistant = (event) => {
                if (event) event.preventDefault();
                assistantCard.classList.add('active-feedback');
                setTimeout(() => assistantCard.classList.remove('active-feedback'), 200);
                if (listeningAnimation.style.display === 'flex') return;
                wikiButton.style.display = 'none';
                speak("Bonjour", () => { 
                    startListeningUI(); 
                    autoRestart = true; 
                    recognition.start(); 
                });
            };

            assistantCard.addEventListener('mousedown', startVocalAssistant); 
            assistantCard.addEventListener('touchstart', startVocalAssistant);
            
            interruptButton.addEventListener('click', () => {
                autoRestart = false; 
                synthesis.cancel();
                isConfirmingStop = true;
                speak("Voulez-vous continuer à parler ?", () => {
                    startListeningUI();
                    recognition.start();
                });
            });

            recognition.onresult = (event) => { 
                autoRestart = false; 
                const transcript = event.results[0][0].transcript.toLowerCase().trim(); 
                if (isConfirmingStop) {
                    isConfirmingStop = false;
                    if (transcript.includes("oui")) {
                        speak("D'accord, posez votre question.", () => {
                            startListeningUI();
                            autoRestart = true; 
                            recognition.start();
                        });
                    } else {
                        statusDiv.textContent = "Au revoir !";
                        speak("Au revoir");
                    }
                } else {
                    if (transcript.includes("j'arrête") || transcript.includes("arrête") || transcript.includes("arrêter")) { 
                        statusDiv.textContent = "Au revoir !"; 
                        speak("Au revoir"); 
                    } else { 
                        callGeminiAPI(transcript); 
                    } 
                }
            };
            
            recognition.onend = () => {
                if (autoRestart) recognition.start();
                else stopListeningUI();
            };

            recognition.onerror = (event) => {
                console.error("Erreur reconnaissance:", event.error);
                if (event.error === 'no-speech') {
                    statusDiv.textContent = "Je n'ai rien entendu, je relance l'écoute...";
                    autoRestart = true;
                } else {
                    statusDiv.textContent = "Une erreur est survenue durant l'écoute.";
                    autoRestart = false;
                }
            };
        }

        async function loadWiki(article) {
          wikiContent.innerHTML = "<h2>Chargement de l'article...</h2>";
          const url = `https://fr.wikipedia.org/w/api.php?action=parse&page=${article}&format=json&origin=*&prop=text&disabletoc=true`;
          try {
            const response = await fetch(url);
            const data = await response.json();
            if(data.parse && data.parse.text) {
              wikiContent.innerHTML = data.parse.text["*"];
              wikiContent.querySelectorAll('.infobox, .mw-editsection, .reference').forEach(el => el.remove());
              wikiContent.querySelectorAll('a').forEach(a => {
                a.style.pointerEvents = 'none';
                a.style.color = 'inherit';
                a.style.textDecoration = 'none';
              });
              wikiContent.querySelectorAll('img').forEach(img => {
                img.style.display = 'block';
                img.style.margin = '20px auto';
                img.style.width = '90%';
                img.style.maxWidth = '600px';
                img.style.height = 'auto';
              });
              wikiContent.querySelectorAll('figcaption, .thumbcaption').forEach(caption => {
                caption.style.width = '90%';
                caption.style.textAlign = 'center';
                caption.style.margin = '0 auto 20px auto';
                caption.style.fontSize = '0.9em';
                caption.style.color = '#555';
              });
            } else {
              wikiContent.innerHTML = "<p>Article non trouvé.</p>";
            }
          } catch (error) {
              console.error("Erreur chargement Wiki:", error);
              wikiContent.innerHTML = "<p>Impossible de charger l'article.</p>";
          }
        }

        wikiButton.addEventListener('click', async (event) => {
            const subject = event.currentTarget.dataset.subject;
            if (!subject) return;
            mainInterface.classList.add('hidden');
            wikiView.classList.remove('hidden');
            await loadWiki(subject);
        });

        closeWikiBtn.addEventListener('click', () => {
            wikiView.classList.add('hidden');
            mainInterface.classList.remove('hidden');
            wikiContent.innerHTML = '';
        });

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
              console.error(`Erreur: ${err.message}`);
            });
          } else {
            document.exitFullscreen();
          }
        });
    </script>
<nav class="bottom-navigation-bar">

    <button class="nav-item" aria-label="Précédent">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </button>

    <a href="index.html" class="nav-item" id="home-button" aria-label="Accueil">
        <svg id="home-icon" viewBox="0 0 28 28">
            <path class="outer-shape" d="M14 2 L23 5 L26 14 L23 23 L14 26 L5 23 L2 14 L5 5 Z" />
            <rect class="inner-shape" x="8.5" y="8.5" width="11" height="11" rx="1" />
        </svg>
    </a>

    <button class="nav-item" aria-label="Menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

</nav>
</body>
</html>
